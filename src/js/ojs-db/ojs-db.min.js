/**
 * @license
 * Copyright (c) 2016 Alan Thales.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * You may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var ArrayMap=function(){function t(){var r=[];return r=Array.apply(r,arguments)||r,r.__proto__=t.prototype,r.mapTable=function(t){return this.map(function(e){return e[t]})},r.indexOfKey=function(t,e){return this.mapTable(t).indexOf(e)},r.put=function(t,e){var n=e||this.length;this[n]=t},r.putRange=function(t,e){if(t&&t instanceof Array){var n,r=e&&"boolean"==typeof e?this.length:0,o=t.length;for(n=0;o>n;n++)this.put(t[n],r+n)}},r.query=function(n){var r=n&&"object"==typeof n?n:{},o=new t;return o.putRange(this.filter(function(t){return e(t,r)})),o},r.orderBy=function(t){var e,n=t&&"object"==typeof t?t:{},r=function(t,e){return"string"==typeof t?t.localeCompare(e):(t>e)-(e>t)},o=function(t,e){return"string"==typeof e?e.localeCompare(t):(e>t)-(t>e)};return this.sort(function(t,i){var a=0;for(e in n){if(t[e]!=i[e]){a="desc"===n[e]?o(t[e],i[e]):r(t[e],i[e]);break}a=0}return a}),this},r.groupBy=function(r,o,i){var a,s,c,f=new t,u=i&&"object"==typeof i?i:{},p=o.length,d={};return this.forEach(function(t){if(e(t,u)){for(s={},c=0;p>c;c++)s[o[c]]=t[o[c]];a=JSON.stringify(s),d[a]=d[a]||[],d[a].push(t)}}),f.putRange(Object.keys(d).map(function(t){return s=JSON.parse(t),n(d[t],r,s)})),f},r.compute=function(t){return n(this,t)},r}var e=function(t,e){var n,r,o,i=!0;for(n in e){if(!i)break;if("object"==typeof e[n]){o=t[n].toString();for(r in e[n]){switch(r){case"$gt":i=t[n]>e[n][r];break;case"$gte":i=t[n]>=e[n][r];break;case"$lt":i=t[n]<e[n][r];break;case"$lte":i=t[n]<=e[n][r];break;case"$start":i=0===o.lastIndexOf(e[n][r],0);break;case"$end":i=-1!==o.indexOf(e[n][r],o.length-e[n][r].length);break;case"$contain":i=o.indexOf(e[n][r])>-1;break;case"$in":i=e[n][r].indexOf(t[n])>-1;break;case"$custom":i=e[n][r].call(e[n][r],t);break;default:i=!1}if(!i)break}}else i=t[n]==e[n]}return i},n=function(t,e,n){var r,o,i,a=e&&e instanceof Array?e:[e],n=n||{};return a.forEach(function(e){for(r in e)break;switch(o=e[r],i=e.alias||o,r){case"$max":t.sort(function(t,e){return e[o]-t[o]}),n[i]=t[0][o];break;case"$min":t.sort(function(t,e){return t[o]-e[o]}),n[i]=t[0][o];break;case"$sum":n[i]=t.map(function(t){return t[o]}).reduce(function(t,e){return parseFloat(t)+parseFloat(e)},0);break;case"$avg":n[i]=t.map(function(t){return t[o]}).reduce(function(t,e){return parseFloat(t)+parseFloat(e)},0),n[i]/=t.length;break;case"$count":n[i]=t.length}}),n};return t.prototype=Object.create(Array.prototype),t.cloneObject=function(t){if("[object Array]"===Object.prototype.toString.call(t)){for(var e=[],n=0,r=t.length;r>n;n++)e[n]=arguments.callee(t[n]);return e}if(t&&!(t instanceof Date)&&"object"==typeof t){var n,e={};for(n in t)e[n]=arguments.callee(t[n]);return e}return t},t}(),DbProxies=function(){return{LOCALSTORAGE:0,SQLITE:1,RESTFUL:2}}(),DbProxy=function(){function t(){}return t.prototype.createDatabase=function(){},t.prototype.getRecords=function(t,e){},t.prototype.commit=function(t,e,n,r,o){},t.dateParser=function(t,e){var n,r=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*))(?:Z|(\+|-)([\d|:]*))?$/;return"string"==typeof e&&(n=r.exec(e))?new Date(e):e},t}(),LocalStorageProxy=function(){function t(){DbProxy.apply(this,arguments)}var e=function(t){var e="object"==typeof t?t.key:t,n=window.localStorage[e],r=new ArrayMap;return n&&r.putRange(JSON.parse(n,DbProxy.dateParser)),r.length&&t.params?r.query(t.params):r},n=function(t,e,n){window.localStorage[t]=JSON.stringify(e),"function"==typeof n&&n()};return t.prototype=Object.create(DbProxy.prototype),t.prototype.getRecords=function(t,n){var r=e(t);t.sort&&r.orderBy(t.sort),"function"==typeof n&&n(r)},t.prototype.query=function(t,n,r){var o=e(t),i=o.query(n);r(i)},t.prototype.groupBy=function(t,n,r,o,i){var a=e(t);i(a.groupBy(n,r,o))},t.prototype.save=function(t,r,o){var i=e(t),a=i.indexOfKey("id",r.id);-1===a?i.push(r):i.splice(a,1,r),n(t,i,o)},t.prototype.remove=function(t,r,o){var i="object"==typeof r?r.id:r,a=e(t),s=a.indexOfKey("id",i);a.splice(s,1),n(t,a,o)},t.prototype.commit=function(t,e,n,r,o){function i(){f--,0===f&&u()}var a,s=this,c=e.concat(n),f=c.length+r.length,u=o&&"function"==typeof o?o:function(){};for(a=0;a<c.length;a++)s.save(t,c[a],i);for(a=0;a<r.length;a++)s.remove(t,r[a],i)},t}(),SQLiteProxy=function(){function t(t){var e;e=window.cordova&&window.sqlitePlugin?window.sqlitePlugin.openDatabase({name:t}):window.openDatabase(t,"SQLite Database","1.0",5242880),this.getDb=function(){return e},DbProxy.apply(this,arguments)}var e=new ArrayMap,n="SELECT * FROM";t.prototype=Object.create(DbProxy.prototype),t.prototype.getFields=function(t){var n=e.indexOfKey("table",t);return e[n].fields},t.prototype.createDatabase=function(t,n){e.length=0,e.putRange(t),this.getDb().transaction(function(e){function r(){u--,0===u&&f()}var o,i,a,s,c,f=n&&"function"==typeof n?n:function(){},u=t.length,p="";for(s=0;s<t.length;s++){for(i=t[s].table,c=0;c<t[s].fields.length;c++)o=t[s].fields[c],p+=[o.name,o.type,o.nullable?"":"NOT NULL",o.primary?"PRIMARY KEY":"",","].join(" ");p=p.substr(0,p.length-1),a=["CREATE TABLE IF NOT EXISTS",i,"(",p,")"].join(" "),e.executeSql(a,[],r)}})};var r=function(t,e,n,r,o){var i,a,s,c,f=self.getFields(t),u=f.map(function(t){return t.name}),p=new ArrayMap;r.executeSql(e,n,function(t,e){for(i=0;i<e.rows.length;i++){a=e.rows.item(i);for(s in a)c=u.indexOf(s),f[c].serialize&&(a[s]=JSON.parse(a[s],DbProxy.dateParser));p.push(a)}"function"==typeof o&&o(p)})},o=function(t){var e,n=[];for(e in t)n.push(e+t[e]);return"ORDER BY "+n.join(",")};t.prototype.getRecords=function(t,e){var i,a=t&&t.key?t.key:t,s=t&&t.sort?o(t.sort):"",c="WHERE ",f=[];if("object"==typeof t){if(f=[n,t.key],t.params){for(i in t.params)c+=i+" = "+t.params[i];f.push(c)}f=f.concat([s,"LIMIT",t.limit])}else f=[n,t];this.getDb().transaction(function(t){r(a,f.join(" "),[],t,e)})};var i=function(t,e){var n="";for(field in e)for(prop in e[field])switch(prop){case"$gt":n+=[field,">",e[field][prop]].join(" ");break;case"$gte":n+=[field,">=",e[field][prop]].join(" ");break;case"$lt":n+=[field,"<",e[field][prop]].join(" ");break;case"$lte":n+=[field,"<=",e[field][prop]].join(" ");break;case"$start":n+=[field," LIKE '",e[field][prop],"%'"].join("");break;case"$end":n+=[field," LIKE '%",e[field][prop],"'"].join("");break;case"$contain":n+=[field," LIKE '%",e[field][prop],"%'"].join("");break;case"$in":n+=[field," IN (",e[field][prop].join(","),")"].join("");break;case"$custom":n+=e[field][prop].call(e[field][prop],field);break;default:n+=""}return""===n?t:[t,"WHERE",n].join(" ")};return t.prototype.query=function(t,e,o){var a=e&&"object"==typeof e?e:{},s=[n,t].join(" "),c=i(s,a);this.getDb().transaction(function(e){r(t,c,[],e,o)})},t.prototype.insert=function(t,e,n,r){var o,i,a,s=[],c="",f="";for(i in e)a=e[i],"object"==typeof a&&(a=JSON.stringify(a)),s.push(a),c+=i+",",f+="?,";c=c.substr(0,c.length-1),f=f.substr(0,f.length-1),o=["INSERT INTO",t,"(",c,") VALUES (",f,")"].join(" "),n.executeSql(o,s,r)},t.prototype.update=function(t,e,n,r){var o,i,a,s=[],c="id = "+e.id,f="";for(i in e)"id"!=i&&(a=e[i],"object"==typeof a&&(a=JSON.stringify(a)),s.push(a),f+=i+" = ?,");f=f.substr(0,f.length-1),o=["UPDATE",t,"set",f,"WHERE",c].join(" "),n.executeSql(o,s,r)},t.prototype["delete"]=function(t,e,n,r){var o,i="object"==typeof e?e.id:e,a="id = "+i;o=["DELETE FROM",t,"WHERE",a].join(" "),n.executeSql(o,[],r)},t.prototype.commit=function(t,e,n,r,o){function i(){return c--,0===c?void f():void 0}var a,s=this,c=e.length+n.length+r.length,f=o&&"function"==typeof o?o:function(){};s.getDb().transaction(function(o){for(a=0;a<e.length;a++)s.insert(t,e[a],o,i);for(a=0;a<n.length;a++)s.update(t,n[a],o,i);for(a=0;a<r.length;a++)s["delete"](t,r[a],o,i)})},t}(),RestProxy=function(){function t(t){throw console.log(JSON.stringify(t)),t.responseText}function e(t,e){this.config=t,e&&"function"==typeof e?this.serialize=e:this.serialize=n,DbProxy.apply(this,arguments)}var n=function(t){return JSON.stringify(t)},r=function(t,e,n,r){var o,i,a=new XMLHttpRequest;if(a.onreadystatechange=function(){4==a.readyState&&(o=200==a.status?n:r)(a)},"object"==typeof e&&e.headers)for(i in e.headers)a.setRequestHeader(i,e.headers[i]);a.open("GET",t,!0),a.send()},o=function(t,e,n,r){var o,i,a,s=new XMLHttpRequest;if(s.onreadystatechange=function(){4==s.readyState&&(o=200==s.status?n:r)(s)},"object"==typeof e){a=e.data;for(i in e.headers)s.setRequestHeader(i,e.headers[i])}s.open("POST",t,!0),s.send(a)},i=function(t,e,n){var o,i="object"==typeof t?t:{key:t},a=this.config.url+"/"+i.key,s=new ArrayMap;if(i.params)for(o in i.params)a+="/"+o+"/"+i.params[o];else a+="/"+this.config.getEP;r(a,this.config,function(t){s.putRange(JSON.parse(t.responseText,DbProxy.dateParser)),e(s)},n)},a=function(t,e,n,r){var i=this.config.url+"/"+t,a={data:this.serialize(e)};this.config.headers&&(a.headers=this.config.headers),o(i,a,function(t){"function"==typeof callback&&n(t)},r)};return e.prototype=Object.create(DbProxy.prototype),e.prototype.getRecords=function(e,n){i(e,function(t){"object"==typeof e&&e.sort&&t.orderBy(e.sort),n(t)},t)},e.prototype.query=function(e,n,r){i(e,function(t){var e=t.query(n);r(e)},t)},e.prototype.groupBy=function(e,n,r,o,a){i(e,function(t){var e=t.groupBy(r,o,n);a(e)},t)},e.prototype.insert=function(e,n,r){var o=e+"/"+this.config.insertEP;a(o,n,r,t)},e.prototype.update=function(e,n,r){var o=e+"/"+this.config.updateEP;a(o,n,r,t)},e.prototype["delete"]=function(e,n,o){var i=this.config.url+"/"+e+"/"+this.config.deleteEP+"/"+n.id,a={};this.config.headers&&(a.headers=this.config.headers),r(i,a,o,t)},e.prototype.commit=function(t,e,n,r,o){function i(){return c--,0===c?void f():void 0}var a,s=this,c=e.length+n.length+r.length,f=o&&"function"==typeof o?o:function(){};for(a=0;a<e.length;a++)s.insert(t,e[a],i);for(a=0;a<n.length;a++)s.update(t,n[a],i);for(a=0;a<r.length;a++)s["delete"](t,r[a],i)},e}(),SyncDb=function(){function t(){}var e={Insert:"_inserted",Update:"_updated",Delete:"_deleted"},n=function(t,e){return["sync_",e,t].join("")},r=function(t,e,r){var o=n(t,e);window.localStorage[o]=JSON.stringify(r)},o=function(t,e){var r=n(t,e),o=window.localStorage[r],i=new ArrayMap;return o&&i.putRange(JSON.parse(o,DbProxy.dateParser)),i},i=function(t,e){var n,r=new ArrayMap,o=t.concat(e);for(n=0;n<o.length;n++)r.indexOfKey("id",parseInt(o[n].id))<0&&r.put(o[n]);return r};return t.prototype.writeData=function(t,n,a,s){var c=o(e.Insert,t),f=o(e.Update,t),u=o(e.Delete,t);c=i(c,n),f=i(f,a),u=i(u,s),r(e.Insert,t,c),r(e.Update,t,f),r(e.Delete,t,u)},t.prototype.cleanData=function(t){r(e.Insert,t,[]),r(e.Update,t,[]),r(e.Delete,t,[])},t.prototype.sendData=function(t,e,n,r,o){"function"==typeof o&&o()},t.prototype.getNews=function(t,e){"function"==typeof e&&e([])},t.prototype.exec=function(t,n){var r=this,i=n||function(){};r.sendData(t,o(e.Insert,t),o(e.Update,t),o(e.Delete,t),function(){r.cleanData(t),r.getNews(t,i)})},t}(),DataSet=function(){function t(t,e,n){var r=t,o=e,i=n;this._inserteds=[],this._updateds=[],this._deleteds=[],this.active=!1,this.limit=1e3,this.sort=null,this.params=null,this.data=new ArrayMap,this.getProxy=function(){return r},this.getTable=function(){return o},this.getSyncronizer=function(){return i}}var e=function(t){t._inserteds.length=0,t._updateds.length=0,t._deleteds.length=0};return t.prototype.open=function(t){function e(t,e){"function"==typeof e&&e(t)}var n=this,r={key:n.getTable(),limit:n.limit,sort:n.sort,params:n.params};return n.active?void e(n.data,t):void n.getProxy().getRecords(r,function(r){n.data=r,n.active=!0,e(r,t)})},t.prototype.close=function(){var t=this;t.active=!1,t.data.length=0,e(t)},t.prototype.getById=function(t){var e=this.data.indexOfKey("id",parseInt(t));return this.data[e]},t.prototype.refresh=function(){var t=this;t.sort&&t.data.orderBy(t.sort)},t.prototype.insert=function(t){if(!this.active)throw"Invalid operation on closed dataset";t.id?t.id=parseInt(t.id):t.id=(new Date).getTime();var e=this.data.indexOfKey("id",t.id);-1===e&&(this._inserteds.push(t),this.data.push(t))},t.prototype.update=function(t){if(!this.active)throw"Invalid operation on closed dataset";if(t.id){t.id=parseInt(t.id);var e=this.data.indexOfKey("id",t.id);this._updateds[e]?this._updateds.splice(e,1,t):this._updateds.push(t),this.data.splice(e,1,t)}},t.prototype.save=function(t){t&&!t.id?this.insert(t):this.update(t)},t.prototype["delete"]=function(t){if(!this.active)throw"Invalid operation on closed dataset";if(t.id){t.id=parseInt(t.id);var e=this.data.indexOfKey("id",t.id);this._deleteds[e]||this._deleteds.push(t),this.data.splice(e,1)}},t.prototype.post=function(t,n){function r(){i&&!n&&i.writeData(o.getTable(),o._inserteds,o._updateds,o._deleteds),e(o),o.refresh(),"function"==typeof t&&t()}if(!this.active)throw"Invalid operation on closed dataset";var o=this,t=t,i=this.getSyncronizer();return o._inserteds.length||o._updateds.length||o._deleteds.length?void o.getProxy().commit(o.getTable(),o._inserteds,o._updateds,o._deleteds,r):void("function"==typeof t&&t())},t.prototype.sync=function(t){var e=this,n=this.getSyncronizer();n&&n.exec(e.getTable(),function(n){var r=new ArrayMap;r.putRange(n),e.data.forEach(function(t){r.indexOfKey("id",t.id)<0&&e["delete"](t)}),r.forEach(function(t){e.data.indexOfKey("id",parseInt(t.id))<0?e.insert(t):e.update(t)}),e.post(t,!0)})},t.prototype.filter=function(t){return t&&"function"==typeof t?this.data.filter(t):this.data.query(t)},t}(),DbFactory=function(){function t(t,e,n){var r,o=n;if(this.getProxy=function(){return r},this.getSynchronizer=function(){return o},t&&"object"==typeof t)return void(r=t);switch(t){case 0:r=new LocalStorageProxy;break;case 1:r=new SQLiteProxy(e);break;case 2:r=new RestProxy(e);break;default:throw"Proxy not implemented"}}return t.prototype.createDatabase=function(t,e){this.getProxy().createDatabase(t,e)},t.prototype.query=function(t,e,n){this.getProxy().query(t,e,n)},t.prototype.groupBy=function(t,e,n,r,o){this.getProxy().groupBy(t,e,n,r,o)},t.prototype.createDataSet=function(t){return new DataSet(this.getProxy(),t,this.getSynchronizer())},t}();